#!/usr/bin/env sh

cd $(dirname $0)
source $(dirname $0)/config

# Panel 
PW=2880
PH=40
PX=0
PY=0

# Functions
ws() {
	ws=$(i3-msg -t get_outputs | sed 's/.*"current_workspace":"\([^"]*\)".*/\1/')
	echo "${ws}"
}

window() {
	window_title=$(xdotool getwindowfocus getwindowname)
	echo "${window_title}"
}

battery_status() {
	BAT=`acpi -b | awk '{gsub(/%,/,""); print $4}' | sed 's/%//g'`
	STATUS=`acpi -b | awk '{gsub(/,/,""); print $3}'`

	# Set Icon
	icon=""
	label=""

	if [[ $STATUS != "Discharging" ]]; then
		icon=""
		label=$STATUS
	elif [[ $BAT -lt 10 ]]; then
		icon=""
		label="$BAT%"
	elif [[ $BAT -lt 40 ]]; then
		icon=""
		label="$BAT%"
	elif [[ $BAT -lt 70 ]]; then
		icon=""
		label="$BAT%"
	elif [[ $BAT -lt 90 ]]; then
		icon=""
		label="$BAT%"
	else
		icon=""
		label="$BAT%"
	fi

	echo "$icon $label"
}

backlight_status() {
	backlight_level=`xbacklight -get|xargs printf "%.0f"`
	echo " $backlight_level%"
}

mpd_status() {
	CMD=`mpc current --format "%title%"`
	icon=""

	echo "$icon $CMD" 
}

get_volume_level() {
	amixer get Master -M | grep -oE -m1 "[[:digit:]]*%" | tr -dc '0-9'
}

volume_status() {
	muted=`amixer get Master -M|grep -oE -m1 "\[on\]"`

	if [[ "$muted" != "[on]" ]]; then
		icon=""
	elif [[ `get_volume_level` -lt 30 ]]; then
		icon=""
	else
		icon=""
	fi

	echo "$icon $(get_volume_level)%"
}

wifi_status() {
	INTERFACE="wlp4s0"
	ESSID=`iwconfig $INTERFACE|grep 'ESSID'|awk '{gsub(/[:/"]/," "); print $5}'`
	LABEL=""

	echo "$LABEL $ESSID"
}

current_time() {
	echo "$(date '+%I:%M %p')"
}

while :; do
	echo "%{B$COLOR1} $(ws) %{B-} $(window) %{c}$(current_time) %{r}$(mpd_status) $(backlight_status) $(volume_status) $(wifi_status) $(battery_status) "
    sleep 1	
		 
done | lemonbar -g ${PW}x${PH}+${PX}+${PY} -f "$FONT1" -f "$ICONFONT1" -p | \
	while read line; do eval "$line"; done &

