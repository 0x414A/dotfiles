#!/usr/bin/env sh

cd $(dirname $0)
source $(dirname $0)/config

# Functions
ws() {
	ws=$(i3-msg -t get_outputs | sed 's/.*"current_workspace":"\([^"]*\)".*/\1/')
	echo "${ws}"
}

window() {
	window_title=$(xdotool getwindowfocus getwindowname)
	echo "${window_title}"
}

battery_status() {
	BAT=`acpi -b | awk '{gsub(/%,/,""); print $4}' | sed 's/%//g'`
	STATUS=`acpi -b | awk '{gsub(/,/,""); print $3}'`

	# Set Icon
	icon=""
	label=""

	if [[ $STATUS != "Discharging" ]]; then
		if [[ $STATUS == "Full" ]]; then
			icon=""
			label="Full"
		elif [[ $STATUS == "Charging" ]]; then
			icon=""
			label="Charging"
		fi
	elif [[ $BAT -lt 10 ]]; then
		icon="%{F$base08}%{F-}"
		label="$BAT%"
	elif [[ $BAT -lt 40 ]]; then
		icon="%{F$base09}%{F-}"
		label="$BAT%"
	elif [[ $BAT -lt 70 ]]; then
		icon=""
		label="$BAT%"
	elif [[ $BAT -lt 90 ]]; then
		icon=""
		label="$BAT%"
	else
		icon=""
		label="$BAT%"
	fi

	echo "$icon"
}

backlight_status() {
	backlight_level=`xbacklight -get|xargs printf "%.0f"`
	icon=""

	if [[ $backlight_level -lt 30 ]]; then
		echo "%{F$base03}$icon%{F-}"
	elif [[ $backlight_level -lt 50 ]]; then
		echo "%{F$base04}$icon%{F-}"
	elif [[ $backlight_level -lt 70 ]]; then
		echo "%{F$base05}$icon%{F-}"
	elif [[ $backlight_level -lt 90 ]]; then
		echo "%{F$base06}$icon%{F-}"
	else
		echo "%{F$base07}$icon%{F-}"
	fi
}

mpd_status() {
	CMD=`mpc current --format "%title%"`
	icon=""

	echo "$CMD %{F$base0C}$icon%{F-}" 
}

get_volume_level() {
	amixer get Master -M | grep -oE -m1 "[[:digit:]]*%" | tr -dc '0-9'
}

volume_status() {
	muted=`amixer get Master -M|grep -oE -m1 "\[on\]"`

	if [[ "$muted" != "[on]" ]]; then
		icon="%{F$base04}%{F-}"
	elif [[ `get_volume_level` -lt 30 ]]; then
		icon=""
	else
		icon=""
	fi

	echo "$icon"
}

wifi_status() {
	INTERFACE="wlp4s0"
	essid=`iwconfig $INTERFACE|grep 'ESSID'|awk '{gsub(/[:/"]/," "); print $5}'`
	icon=""

	if [[ -z "${essid// }" ]]; then
		echo "%{F$base04}$icon%{F-}"
	else
		echo "%{F$base06}$icon%{F-}"
	fi
}

current_time() {
	echo "$(date '+%I:%M %p')"
}

while :; do
	echo "%{B$BG2}  $(ws)  %{B-}%{B$BG1}   $(window)   %{B-} %{c}%{F$base07}$(current_time)%{F-} %{r}%{B$BG1}  $(backlight_status)  $(volume_status)  $(wifi_status)  $(battery_status)  %{B-}"
    sleep 1	
		 
done | lemonbar -g ${PW}x${PH}+${PX}+${PY} -f "$FONT1" -f "$ICONFONT1" -B "$base00" -F "$base06" -p | \
	while read line; do eval "$line"; done &

